<field-htmlbuilder>

    <style>
        
        .html-builder-container {
            display: none;
            position: fixed;
            box-sizing: border-box;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            overflow: auto;
            z-index: 10;
        }

        .html-builder-container.open {
            display: block;
        }

        .html-builder-toolbar {
            padding: 10px 20px;
            box-shadow: 0 0 40px rgba(0,0,0,.2);
        }

        .html-builder-content {
            padding:  40px 20px 20px 20px;
            position: absolute;
            top: 60px;
            bottom: 0;
            left: 0;
            right: 0;
            overflow: auto;
        }

        div[ref="content"] {
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        [data-component]:empty:not(hr):after {
            content: attr(data-component);
            text-transform: capitalize;
            color: #eee;
        }

        .bl-grid > div {
            min-height: 100px;
        }

    </style>

    <div class="uk-panel-box uk-panel-card uk-text-muted uk-text-center">
        <div class="uk-alert">The Layout Builder is in active development. <strong>Use at your own risk</strong>.</div>
        <img class="uk-svg-adjust" riot-src="{ App.base('/addons/Copilot/assets/layout-builder/layout.svg') }" width="100" data-uk-svg>
        <div><a onclick="{ openBuilder }" title="{ App.i18n.get('Open Layout Builder') }" data-uk-tooltip><i class="uk-icon-button uk-icon-pencil"></i></a></div>
    </div>

    <div class="html-builder-container" ref="container">
        
        <div class="html-builder-toolbar uk-flex uk-flex-middle">
            <strong>Layout Builder</strong>
            <div class="uk-flex-item-1"></div>
            <a class="uk-margin-right" onclick="{emptyBuilder}" show="{ value }"><i class="uk-icon-trash-o"></i></a>
            <a onclick="{hideBuilder}"><i class="uk-icon-button uk-icon-close"></i></a>
        </div>
        
        <div class="html-builder-content" show="{value}">
            <div ref="content"></div>
            <div class="uk-margin uk-text-center" builder-gui>
                <a class="uk-text-xlarge" onclick="{ addComponent }" title="{ App.i18n.get('Add Content') }" data-uk-tooltip><i class="uk-icon-plus-circle"></i></a>
            </div>

            <html-builderoverlay each="{element in overlays}" element="{element}"></html-builderoverlay>
        </div>
        
        <div class="uk-margin-large-top uk-viewport-height-1-3 uk-container-center uk-text-center uk-flex uk-flex-middle uk-flex-center uk-animation-scale" if="{!value.trim()}">
            <div>
                <img class="uk-svg-adjust uk-text-muted" riot-src="{ App.base('/addons/Copilot/assets/layout-builder/layout.svg') }" width="100" data-uk-svg>
                <p class="uk-h1 uk-text-bold">{ App.i18n.get('No Content yet') }</p>
                <a class="uk-text-xlarge" onclick="{ addComponent }" title="{ App.i18n.get('Add Content') }" data-uk-tooltip><i class="uk-icon-plus-circle"></i></a>
            </div>
        </div>
    </div>

    <div class="uk-modal" ref="components">

        <div class="uk-modal-dialog uk-width-medium-1-2">
            <a class="uk-modal-close uk-close"></a>
            <h3 class="uk-flex uk-flex-middle">
                <img class="uk-margin-small-right" src="{ App.base('/addons/Copilot/assets/layout-builder/icons/default.svg') }" width="30" align="absmiddle">
                { App.i18n.get('HTML Components') }
            </h3>

            <div class="uk-grid uk-grid-small uk-grid-width-small-1-2 uk-grid-width-medium-1-5" if="{ window.HTMLBuilder }">
                <div class="uk-grid-margin uk-text-center" each="{ meta, component in HTMLBuilder.components}">
                    <div class="uk-panel uk-panel-hover uk-panel-framed">
                        <img class="uk-text-muted uk-svg-adjust" riot-src="{ App.base(meta.icon || '/addons/Copilot/assets/layout-builder/icons/default.svg') }" width="30" data-uk-svg>
                        <div class="uk-margin uk-text-small uk-text-bold">{ meta.label }</div>
                        <a class="uk-position-cover uk-modal-close" onclick="{ parent.injectComponent.bind(parent, component) }"></a>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="uk-modal" ref="html">

        <div class="uk-modal-dialog uk-width-medium-2-3">
            <a class="uk-modal-close uk-close"></a>
            <h3>{ App.i18n.get('Code') }</h3>
            <codemirror ref="code" syntax="html"></codemirror>

            <div class="uk-margin-top uk-text-right">
                <button type="button" class="uk-button uk-button-large uk-button-primary" onclick="{ saveHtml }">{ App.i18n.get('Save') }</button>
            </div>
        </div>

    </div>

    <div class="uk-modal" ref="edit">

        <div class="uk-modal-dialog uk-width-medium-1-2" if="{ editElement }">
            <a class="uk-modal-close uk-close"></a>
            <h3 class="uk-text-uppercase"><i class="uk-icon-pencil uk-margin-small-right"></i> { editElement.getAttribute('data-component') }</h3>
            
            <ul class="uk-tab" data-uk-tab="connect:'#{uid}'">
                <li if="{App.Utils.count(editElement._fields)}"><a>{ App.i18n.get('Element') }</a></li>
                <li><a>{ App.i18n.get('General') }</a></li>
                <li><a>{ App.i18n.get('Style') }</a></li>
            </ul>

            <div id="{uid}" class="uk-switcher uk-margin-top uk-form">
                <div if="{App.Utils.count(editElement._fields)}">
                    <div class="uk-form-row" each="{field, uid in editElement._fields}">
                        <label class="uk-text-small uk-text-uppercase">{field.prop}</label>
                        <div class="uk-margin-small-top" data-is="{'field-'+field.type}" data-prop="{field.prop}" data-uid="{field.uid}"></div>
                    </div>
                </div>
                <div class="uk-active">
                    <div class="uk-form-row">
                        <label class="uk-text-small uk-text-uppercase">Id</label>
                        <input class="uk-width-1-1 uk-margin-small-top" type="text" data-attribute="id" value="{ editElement.getAttribute('id') }">
                    </div>
                    <div class="uk-form-row">
                        <label class="uk-text-small uk-text-uppercase">Class</label>
                        <input class="uk-width-1-1 uk-margin-small-top" type="text" data-attribute="class" value="{ editElement.getAttribute('class') }">
                    </div>
                </div>
                <div>
                    <div class="uk-form-row">
                        <label class="uk-text-small uk-text-uppercase">Style</label>
                        <textarea class="uk-width-1-1 uk-margin-small-top" data-attribute="style" name="style" style="min-height:200px;font-family:monospace;" placeholder="color:red;"></textarea>
                    </div>
                </div>

            </div>

            <div class="uk-margin-large-top uk-text-right">
                <button type="button" class="uk-button uk-button-large uk-button-primary" onclick="{ saveEdit }">{ App.i18n.get('Save') }</button>
            </div>
        </div>

    </div>
    
    <script>

        var $this = this;

        this.value = '';
        this.overlays = [];

        this.$updateValue = function(value, field) {
            
            if (this.value != value) {
                this.value = value;
                this.refs.content.innerHTML = value;
                App.$(this.refs.content).find('[data-component]');
            }

        }.bind(this);

        function guid() {
            function s4() {
                return Math.floor((1 + Math.random()) * 0x10000)
                .toString(16)
                .substring(1);
            }
            return s4() + s4() + '-' + s4() + '-' + s4() + '-' + s4() + '-' + s4() + s4() + s4();
        }

        this.on('mount', function() {

            this.uid = 'hb-xxxxxxxx'.replace(/[x]/g, function(c) {
                var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
                return v.toString(16);
            });

            App.assets.require([
                '/addons/Copilot/assets/layout-builder/htmlbuilder.js',
                '/addons/Copilot/assets/layout-builder/beautify-html.js',
                '/addons/Copilot/assets/layout-builder/layout-builder.css'
            ], function() {

                App.$(this.root).on('mouseenter', '[data-component]', function(e) {
                    
                    if (!this._builderoverlay) {
                        $this.overlays.push(this);
                        this._builderoverlay = true;
                        $this.update();
                    }
                });

                this.update();

            }.bind(this));
        });

        doUpdate() {

            var clone = App.$(this.refs.content).clone();
            
            clone.find('[contenteditable]').removeAttr('contenteditable');

            this.value = clone.html();
            this.$setValue(this.value, true);

            delete clone;

            this.update();
        }

        emptyBuilder() {
            this.refs.content.innerHTML = '';
            this.doUpdate();
        }

        hideBuilder() {
            this.doUpdate();
            this.refs.container.classList.remove('open');
        }

        openBuilder() {
            this.refs.container.classList.add('open');
        }

        addComponent(container, after) {
            
            this.refs.components._container = !container.target ? container : this.refs.content;
            this.refs.components._after = after;

            UIkit.modal(this.refs.components).show();
        }

        injectComponent(component) {

            var container = this.refs.components._container,
                after = this.refs.components._after;

            var method  = after ? 'injectAfter':'inject',
                element = after ? after : container;

            HTMLBuilder[method](component, element).then(function(template) {
                $this.doUpdate();
                $this.update();
            });
        }

        edit(element) {

            this.editElement = element;

            var fields = {};

            App.$(this.editElement).find('[data-builder-edit]').add(this.editElement).each(function() {

                if (!this.matches('[data-builder-edit]')) {
                    return;
                }

               var element = this;

               this.getAttribute('data-builder-edit').split(',').forEach(function(field) {
                
                    var def   = field.split(':');
                    var prop  = def[0];
                    var type  = def[1] || 'text';
                    var uid   = guid();
                    var value = null;

                    if (prop == 'html' || prop == 'text') {
                        value = App.$(element)[prop]();
                    } else if(['id', 'class', 'src','href','width','height','alt','target'].indexOf(prop)) {
                        value = App.$(element).attr(prop);
                    }

                    fields[uid] = {
                        uid: uid,
                        prop: prop,
                        type: type,
                        element: element,
                        value: value
                    };
               });
            });

            this.editElement._fields = fields;

            setTimeout(function() {

                var styles = (this.editElement.getAttribute('style') || '').split(';').join(";\n");

                this.refs.edit.querySelector('[name=style]').value = styles;

                App.$('[data-prop]').each(function(){

                    var uid = this.getAttribute('data-uid');

                    this._tag.$setValue = function(value) {
                        fields[uid].value = value;
                    };

                    this._tag.$updateValue(fields[uid].value, uid);
                });

                UIkit.modal(this.refs.edit).show().one('hide.uk.modal',function() {
                    $this.editElement = null;
                });

            }.bind(this), 50);

            this.update();
        }

        saveEdit() {

            var val, attr;

            App.$(this.refs.edit).find('[data-attribute]').each(function(){
                
                val = this.value.trim();
                attr = this.getAttribute('data-attribute');

                if (val) {
                    if (attr == 'style') val = val.replace(/\n/, '');
                    $this.editElement.setAttribute(attr, val);
                } else {
                    $this.editElement.removeAttribute(attr)
                }
            });

            App.$.each(this.editElement._fields, function(key, field) {
                
                var $element = App.$(field.element);

                if (field.prop == 'html' || field.prop == 'text') {
                    $element[field.prop](field.value);
                } else if(['id', 'class', 'src','href','width','height','alt','target'].indexOf(field.prop)) {
                    $element.attr(field.prop, field.value);
                }
            });

            this.editElement = null;

            UIkit.modal(this.refs.edit).hide();
        }

        editHTML(element) {
            
            var value = element.outerHTML;

            this.refs.code._element = element;

            setTimeout(function() {
                $this.refs.code.editor.refresh();
                $this.refs.code.editor.setValue(html_beautify(value || ''));
            }, 100);

            UIkit.modal(this.refs.html).show();
        }

        saveHtml() {
            App.$(this.refs.code._element).replaceWith($this.refs.code.editor.getValue());
            UIkit.modal(this.refs.html).hide();
        }

    </script>

</field-htmlbuilder>

<html-builderoverlay>
    
    <style>
    
        .container {
            visibility: hidden;
            pointer-events:none;
            position: absolute;
            color: #fff;
        }

        .container.open {
            visibility: visible;
            pointer-events:auto;
        }

        .actions {
            display: flex;
            align-items: center;
            position: absolute;
            top: 0;
            left: 0;
            box-sizing: border-box;
            background: #222;
            padding: 3px 8px;
            transform: translateY(-100%);
        }

        div[ref="componentframe"] {
            position: absolute;
            box-sizing: border-box;
            top: 0;
            left: 0;
            border: 2px #222 solid;
            pointer-events: none;
        }

        .container[data-element='column'] .actions {
            transform: translateY(0) translateX(-100%);
            flex-direction: column;
            padding: 8px 3px;
        }

        .container[data-element='column'] .actions strong { display: none; }
    
    </style>


    <div class="container {active ? 'open':''}" data-element="{component}" ref="container">
        <div class="actions" ref="actions">
            <strong class="uk-text-uppercase uk-text-small uk-margin-right">{ component }</strong>
            <a class="uk-button uk-button-small uk-button-link" onclick="{addComponent}"><i class="uk-icon-plus-circle"></i></a>
            <a class="uk-button uk-button-small uk-button-link" onclick="{cloneComponent}"><i class="uk-icon-clone"></i></a>
            <a class="uk-button uk-button-small uk-button-link" onclick="{moveUp}" show="{opts.element && App.$(opts.element).prev('[data-component]').length}"><i class="uk-icon-caret-up"></i></a>
            <a class="uk-button uk-button-small uk-button-link" onclick="{moveDown}" show="{opts.element && App.$(opts.element).next('[data-component]').length}"><i class="uk-icon-caret-down"></i></a>
            <a class="uk-button uk-button-small uk-button-link" onclick="{edit}"><i class="uk-icon-pencil"></i></a>
            <a class="uk-button uk-button-small uk-button-link" onclick="{parent.editHTML.bind(parent, element)}"><i class="uk-icon-code"></i></a>
            <a class="uk-button uk-button-small uk-button-link" onclick="{remove}"><i class="uk-icon-trash-o"></i></a>
        </div>
        <div ref="componentframe"></div>
    </div>

    <script>

        var $this = this, actionsIdle;

        this.active = false;

        this.on('mount', function() {

            this.element = opts.element;
            this.component = this.element.getAttribute('data-component');
            this.inColumn  = App.$(this.element).closest('[data-component="column"]').length;


            App.$([this.element, this.refs.actions]).on('mousemove', function(e) {
                
                if (actionsIdle) clearTimeout(actionsIdle);
                
                if ($this.active) {
                    return;
                }

                //e.stopPropagation();

                if (this === $this.refs.actions) return;
                
                $this.show();
            });

            App.$([this.element, $this.refs.actions]).on('mouseleave', function(e) {

                actionsIdle = setTimeout(function() {

                    $this.active = false;
                    $this.update();
                }, 50)
            });

            this.show();
        });

        show() {
            
            this.active = true;

            App.$(this.refs.container).css({
                top: this.element.offsetTop,
                left: this.element.offsetLeft
            });

            App.$(this.refs.componentframe).css({
                width: this.element.offsetWidth,
                height: this.element.offsetHeight,
                opacity: this.inColumn || this.component == 'column' ? 0:1
            });

            if (this.inColumn && this.component != 'column') {
                App.$(this.refs.actions).css({
                    top: this.element.offsetHeight + (this.refs.actions.offsetHeight  > this.element.offsetHeight ? this.refs.actions.offsetHeight:0 )
                });
            }

            this.update();
        }

        addComponent() {

            if (this.component == 'column') {
                this.parent.addComponent(this.element);
            } else {
                this.parent.addComponent(this.element.parentNode, this.element);
            }
        }

        cloneComponent() {
            App.$(this.element).after(this.element.outerHTML);
        }

        remove() {
            App.$(this.element).remove();
            this.parent.overlays.splice(this.parent.overlays.indexOf(this.element), 1);
            this.parent.doUpdate();
        }

        moveUp() {
            this.show(App.$(this.element).prev('[data-component]').before(this.element));
        }

        moveDown() {
            this.show(App.$(this.element).next('[data-component]').after(this.element));
        }

        edit() {
            this.parent.edit(this.element);
        }

    </script>

</html-builderoverlay>