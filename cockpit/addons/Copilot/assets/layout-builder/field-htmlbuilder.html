<field-htmlbuilder>

    <style>
        
        .html-builder-container {
            display: none;
            position: fixed;
            box-sizing: border-box;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            overflow: auto;
            z-index: 10;
        }

        .html-builder-container.open {
            display: block;
        }

        .html-builder-toolbar {
            padding: 10px 20px;
            box-shadow: 0 0 40px rgba(0,0,0,.2);
        }
        .html-builder-content {
            padding:  40px 20px 20px 20px;
            position: absolute;
            top: 60px;
            bottom: 0;
            left: 0;
            right: 0;
            overflow: hidden;
        }

        .html-builder-actions {
            position: absolute;
            box-sizing: border-box;
            background: #222;
            padding: 3px 8px;
            color: #fff;
            margin-top: -30px;
        }

        div[ref="componentframe"] {
            position: absolute;
            box-sizing: border-box;
            left: 0;
            top: 100%;
            border: 2px #222 solid;
            pointer-events: none;
        }

        div[ref="content"] {
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
        }

        [data-component]:empty:not(hr):after {
            content: attr(data-component);
            text-transform: capitalize;
            color: #eee;
        }

    </style>

    <div class="uk-panel-box uk-panel-card uk-text-muted uk-text-center">
        <div class="uk-alert">The Layout Builder is in active development. <strong>Use at your own risk</strong>.</div>
        <img class="uk-svg-adjust" riot-src="{ App.base('/addons/Copilot/assets/layout-builder/layout.svg') }" width="100" data-uk-svg>
        <div><a onclick="{ openBuilder }" title="{ App.i18n.get('Open Layout Builder') }" data-uk-tooltip><i class="uk-icon-button uk-icon-pencil"></i></a></div>
    </div>

    <div class="html-builder-container" ref="container">
        
        <div class="html-builder-toolbar uk-flex uk-flex-middle">
            <strong>HTML Builder</strong>
            <div class="uk-flex-item-1"></div>
            <a class="uk-margin-right" onclick="{emptyBuilder}" show="{ value }"><i class="uk-icon-trash-o"></i></a>
            <a onclick="{hideBuilder}"><i class="uk-icon-button uk-icon-close"></i></a>
        </div>
        
        <div class="html-builder-content" show="{value}">
            <div ref="content"></div>
            <div class="uk-margin uk-text-center" builder-gui>
                <a class="uk-text-xlarge" onclick="{ addComponent }" title="{ App.i18n.get('Add Content') }" data-uk-tooltip><i class="uk-icon-plus-circle"></i></a>
            </div>
            <div class="html-builder-actions uk-flex uk-flex-middle" ref="actions" show="{activeComponent}">
                <strong class="uk-text-uppercase uk-text-small uk-margin-right">{ activeComponent && activeComponent.getAttribute('data-component') }</strong>
                <a class="uk-button uk-button-small uk-button-link" onclick="{addComponent}"><i class="uk-icon-plus-circle"></i></a>
                <a class="uk-button uk-button-small uk-button-link" onclick="{cloneComponent}"><i class="uk-icon-clone"></i></a>
                <a class="uk-button uk-button-small uk-button-link" onclick="{moveUp}" show="{activeComponent && App.$(activeComponent).prev('[data-component]').length}"><i class="uk-icon-caret-up"></i></a>
                <a class="uk-button uk-button-small uk-button-link" onclick="{moveDown}" show="{activeComponent && App.$(activeComponent).next('[data-component]').length}"><i class="uk-icon-caret-down"></i></a>
                <a class="uk-button uk-button-small uk-button-link" onclick="{editHTML}"><i class="uk-icon-code"></i></a>
                <a class="uk-button uk-button-small uk-button-link" onclick="{remove}"><i class="uk-icon-trash-o"></i></a>
                <div ref="componentframe"></div>
            </div>
        </div>
        
        <div class="uk-margin-large-top uk-viewport-height-1-3 uk-container-center uk-text-center uk-flex uk-flex-middle uk-flex-center uk-animation-scale" if="{!value.trim()}">
            <div>
                <img class="uk-svg-adjust uk-text-muted" riot-src="{ App.base('/addons/Copilot/assets/layout-builder/layout.svg') }" width="100" data-uk-svg>
                <p class="uk-h1 uk-text-bold">{ App.i18n.get('No Content yet') }</p>
                <a class="uk-text-xlarge" onclick="{ addComponent }" title="{ App.i18n.get('Add Content') }" data-uk-tooltip><i class="uk-icon-plus-circle"></i></a>
            </div>
        </div>
    </div>

    <div class="uk-modal" ref="components">

        <div class="uk-modal-dialog uk-width-medium-1-2">
            <a class="uk-modal-close uk-close"></a>
            <h3><i class="uk-icon-cubes uk-margin-small-right"></i> { App.i18n.get('HTML Components') }</h3>

            <div class="uk-grid uk-grid-small uk-grid-width-medium-1-3">
                <div class="uk-grid-margin uk-text-center" each="{ snippet, component in snippets}">
                    <div class="uk-panel uk-panel-framed">
                        { snippet.label }
                        <a class="uk-position-cover uk-modal-close" onclick="{ parent.addSnippet }"></a>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div class="uk-modal" ref="html">

        <div class="uk-modal-dialog uk-width-medium-2-3">
            <a class="uk-modal-close uk-close"></a>
            <h3>{ App.i18n.get('Code') }</h3>
            <codemirror ref="code" syntax="html"></codemirror>

            <div class="uk-margin-top uk-text-right">
                <button type="button" class="uk-button uk-button-large uk-button-primary" onclick="{ saveHtml }">{ App.i18n.get('Save') }</button>
            </div>
        </div>

    </div>
    
    <script>

        var $this = this, actionsIdle;

        this.value = '';

        this.snippets = {
            "heading": {label: 'Heading', html:'<h1>Header</h1>'},
            "html": {label: 'Html', html:'<div>Html Code....</div>'},
            "text": {label: 'Text', html:'<p>Lorem Ipsum....</p>'},
            "button": {label: 'Button', html:'<div><button>Button</button></div>'},
            "divider": {label: 'Divider', html:'<hr>'},
            "video": {label: 'Video', html:'<div><video src="" data-media="video" width="600" height="400"></video></div>'},
            "audio": {label: 'Audio', html:'<div><audio src="" data-media="audio"></audio></div>'},
            "image": {label: 'Image', html:'<div><img src="" data-media="image" width="400" height="300"></div>'},
            "spacer": {label: 'Spacer', html:'<div style="height:40px;"></div>'},
            "map": {label: 'Map', html:'<div><iframe width="100%" height="400" frameborder="0" scrolling="no" marginheight="0" marginwidth="0" src="https://maps.google.com/maps?q=Melbourne,+Victoria,+Australia&amp;hl=en&amp;sll=-7.981898,112.626504&amp;sspn=0.009084,0.016512&amp;oq=melbourne&amp;hnear=Melbourne+Victoria,+Australia&amp;t=m&amp;z=10&amp;output=embed"></iframe></div>'}
        };

        this.$updateValue = function(value, field) {
            
            if (this.value != value) {
                this.value = value;
                this.refs.content.innerHTML = value;
                App.$(this.refs.content).find('[data-component]');
            }

        }.bind(this);

        this.on('mount', function() {

            App.assets.require([
                '/addons/Copilot/assets/layout-builder/beautify-html.js',
                '/addons/Copilot/assets/layout-builder/layout-builder.css'
            ], function() {});

            App.$(this.root).on('mouseenter', '[data-component]', function(e) {
                
                if (actionsIdle) clearTimeout(actionsIdle);

                e.stopPropagation();

                $this.activate(this);

                App.$($this.refs.actions).css({
                    top: this.offsetTop,
                    left: this.offsetLeft
                }).addClass('open');

                $this.update();
            });

            App.$(this.root).on('click', function(e) {

                if (!App.$(e.target).parents('[data-component]').length) {
                    $this.deactivate();
                    $this.update();
                };
            });


            this.trigger('update');
        });

        deactivate() {
            this.activeComponent = false;
        }

        activate(component) {
            this.deactivate();
            this.activeComponent = component;
            App.$(this.refs.componentframe).css({
                width: component.offsetWidth,
                height: component.offsetHeight
            });
        }

        doUpdate() {

            var clone = App.$(this.refs.content).clone();
            
            clone.find('[contenteditable]').removeAttr('contenteditable');

            this.value = clone.html();
            this.$setValue(this.value, true);

            delete clone;
        }

        emptyBuilder() {
            this.refs.content.innerHTML = '';
            this.doUpdate();
        }

        hideBuilder() {
            this.doUpdate();
            this.refs.container.classList.remove('open');
        }

        openBuilder() {
            this.refs.container.classList.add('open');
        }

        addComponent(e) {

            this.refs.components._activeComponent = null;

            if (App.$(e.target).parents('.html-builder-actions').length) {
                this.refs.components._activeComponent = this.activeComponent;
            }

            UIkit.modal(this.refs.components).show();
        }

        cloneComponent() {
            App.$(this.activeComponent).after(this.activeComponent.outerHTML);
        }

        addSnippet(e) {

            var component = App.$(e.item.snippet.html).attr('data-component', e.item.component);

            component.find('audio,video,img').filter('[src=""]').each(function() {
                
                if (this.matches('img')) {

                } else if(this.matches('audio')) {

                } else if(this.matches('video')) {
                    
                }
            });

            if (this.refs.components._activeComponent) {
                App.$(this.refs.components._activeComponent).after(component);
            } else {
                App.$(this.refs.content).append(component);
            }


            this.doUpdate();
        }

        remove() {
            App.$(this.activeComponent).remove();
            this.deactivate();
            this.doUpdate();
        }

        moveUp(e) {
            App.$(this.activeComponent).prev('[data-component]').before(this.activeComponent);
            this.doUpdate();
        }

        moveDown(e) {
            App.$(this.activeComponent).next('[data-component]').after(this.activeComponent);
            this.doUpdate();
        }

        editHTML() {
            
            var value = this.activeComponent.outerHTML;

            this.refs.code._activeComponent = this.activeComponent;

            setTimeout(function() {
                $this.refs.code.editor.refresh();
                $this.refs.code.editor.setValue(html_beautify(value || ''));
            }, 100);

            UIkit.modal(this.refs.html).show();
        }

        saveHtml() {
            App.$(this.refs.code._activeComponent).replaceWith($this.refs.code.editor.getValue());
            UIkit.modal(this.refs.html).hide();
        }

    </script>

</field-htmlbuilder>